<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>tech-docs | Technical documentation for ArchivesSpace</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="tech-docs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Technical documentation for ArchivesSpace" />
<meta property="og:description" content="Technical documentation for ArchivesSpace" />
<meta property="og:site_name" content="tech-docs" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="tech-docs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Technical documentation for ArchivesSpace","headline":"tech-docs","url":"/tech-docs/provisioning/clustering.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/tech-docs/assets/css/style.css?v=">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/tech-docs/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <style>
  /* Styles via https://getbootstrap.com/docs/5.3/components/alerts/#icons */
  .deprecation-alert {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin-bottom: 1.5rem;
    color: #58151c;
    background-color: #f8d7da;
    border: 1px solid #f1aeb5;
    border-radius: 0.375rem;
  }
  .deprecation-alert__svg {
    flex-shrink: 0 !important;
    width: 1em;
    height: 1em;
    margin-right: 0.5rem !important;
    fill: currentcolor;
  }
</style>

<aside class="deprecation-alert">
  <svg
    xmlns="http://www.w3.org/2000/svg"
    id="exclamation-triangle-fill"
    viewBox="0 0 16 16"
    class="deprecation-alert__svg"
    role="img"
    aria-label="Danger:"
  >
    <path
      d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"
    />
  </svg>

  <p style="margin-bottom: 0">
    <em style="margin-right: 0.25rem; font-weight: 700">NOTE!</em> We recently
    launched a
    <a href="https://docs.archivesspace.org"
      >new technical documentation site</a
    >
    as part of the ArchivesSpace v4.0.0 release.
    <br />
    For now both sites will be live, but we encourage you to take a look at the
    new site and leave feedback or suggestions.
  </p>
</aside>


      <header>
        <h1><a href="/tech-docs/">tech-docs</a></h1>

        

        <p>Technical documentation for ArchivesSpace</p>

        
        <p class="view"><a href="https://github.com/archivesspace/tech-docs">View the Project on GitHub <small>archivesspace/tech-docs</small></a></p>
        

        

        

        <p>
          <a
            href="https://github.com/archivesspace/tech-docs/edit/master/provisioning/clustering.md"
            title="Edit provisioning/clustering.md on GitHub"
          >
            Edit this page on GitHub
            <small>provisioning/clustering.md</small>
          </a>
        </p>

        <p>
          <a
            href="https://archivesspace.atlassian.net/jira/software/projects/TD/issues"
            title="Report issue with provisioning/clustering.md on Jira"
          >
            Report issue on Jira
            <small>provisioning/clustering.md</small>
          </a>
        </p>
      </header>
      <section>

      <h1 id="running-archivesspace-with-load-balancing-and-multiple-tenants">Running ArchivesSpace with load balancing and multiple tenants</h1>

<p>This document describes two aspects of running ArchivesSpace in a
clustered environment: for load-balancing purposes, and for supporting
multiple tenants (isolated installations of the system in a common
deployment environment).</p>

<p>The configuration described in this document is one possible approach,
but it is not intended to be prescriptive: the application layer of
ArchivesSpace is stateless, so any mechanism you prefer for load
balancing across web applications should work just as well as the one
described here.</p>

<p>Unless otherwise stated, it is assumed that you have root access on
your machines, and all commands are to be run as root (or with sudo).</p>

<h2 id="architecture-overview">Architecture overview</h2>

<p>This document assumes an architecture with the following components:</p>

<ul>
  <li>A load balancer machine running the Nginx web server</li>
  <li>Two application servers, each running a full ArchivesSpace
application stack</li>
  <li>A MySQL server</li>
  <li>A shared NFS volume mounted under <code class="language-plaintext highlighter-rouge">/aspace</code> on each machine</li>
</ul>

<h2 id="overview-of-files">Overview of files</h2>

<p>The <code class="language-plaintext highlighter-rouge">files</code> directory in this repository (in the same directory as this
<code class="language-plaintext highlighter-rouge">README.md</code>) contains what will become the contents of the <code class="language-plaintext highlighter-rouge">/aspace</code>
directory, shared by all servers.  It has the following layout:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /aspace
 ├── archivesspace
 │   ├── config
 │   │   ├── config.rb
 │   │   └── tenant.rb
 │   ├── software
 │   └── tenants
 │       └── \_template
 │           └── archivesspace
 │               ├── config
 │               │   ├── config.rb
 │               │   └── instance_hostname.rb.example
 │               └── init_tenant.sh
 └── nginx
     └── conf
         ├── common
         │   └── server.conf
         └── tenants
             └── \_template.conf.example
</code></pre></div></div>

<p>The highlights:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/aspace/archivesspace/config/config.rb</code> – A global configuration file for all ArchivesSpace instances.  Any configuration options added to this file will be applied to all tenants on all machines.</li>
  <li><code class="language-plaintext highlighter-rouge">/aspace/archivesspace/software/</code> – This directory will hold the master copies of the <code class="language-plaintext highlighter-rouge">archivesspace.zip</code> distribution.  Each tenant will reference one of the versions of the ArchivesSpace software in this directory.</li>
  <li><code class="language-plaintext highlighter-rouge">/aspace/archivesspace/tenants/</code> – Each tenant will have a sub-directory under here, based on the <code class="language-plaintext highlighter-rouge">_template</code> directory provided.  This holds the configuration files for each tenant.</li>
  <li><code class="language-plaintext highlighter-rouge">/aspace/archivesspace/tenants/[tenant name]/config/config.rb</code> – The global configuration file for [tenant name].  This contains tenant-specific options that should apply to all of the tenant’s ArchivesSpace instances (such as their database connection settings).</li>
  <li><code class="language-plaintext highlighter-rouge">/aspace/archivesspace/tenants/[tenant name]/config/instance_[hostname].rb</code> – The configuration file for a tenant’s ArchivesSpace instance running on a particular machine.  This allows configuration options to be set on a per-machine basis (for example, setting different ports for different application servers)</li>
  <li><code class="language-plaintext highlighter-rouge">/aspace/nginx/conf/common/server.conf</code> – Global Nginx configuration settings (applying to all tenants)</li>
  <li><code class="language-plaintext highlighter-rouge">/aspace/nginx/conf/tenants/[tenant name].conf</code> – A tenant-specific Nginx configuration file.  Used to set the URLs of each tenant’s ArchivesSpace instances.</li>
</ul>

<h2 id="getting-started">Getting started</h2>

<p>We’ll assume you already have the following ready to go:</p>

<ul>
  <li>Three newly installed machines, each running RedHat (or CentOS)
Linux (we’ll refer to these as <code class="language-plaintext highlighter-rouge">loadbalancer</code>, <code class="language-plaintext highlighter-rouge">apps1</code> and
<code class="language-plaintext highlighter-rouge">apps2</code>).</li>
  <li>A MySQL server.</li>
  <li>An NFS volume that has been mounted as <code class="language-plaintext highlighter-rouge">/aspace</code> on each machine.
All machines should have full read/write access to this area.</li>
  <li>An area under <code class="language-plaintext highlighter-rouge">/aspace.local</code> which will store instance-specific
files (such as log files and Solr indexes).  Ideally this is just
a directory on local disk.</li>
  <li>Java 1.6 (or above) installed on each machine.</li>
</ul>

<h3 id="populate-your-aspace-directory">Populate your /aspace/ directory</h3>

<p>Start by copying the directory structure from <code class="language-plaintext highlighter-rouge">files/</code> into your
<code class="language-plaintext highlighter-rouge">/aspace</code> volume.  This will contain all of the configuration files
shared between servers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> mkdir /var/tmp/aspace/
 cd /var/tmp/aspace/
 unzip -x /path/to/archivesspace.zip
 cp -av archivesspace/clustering/files/* /aspace/
</code></pre></div></div>

<p>You can do this on any machine that has access to the shared
<code class="language-plaintext highlighter-rouge">/aspace/</code> volume.</p>

<h3 id="install-the-cluster-init-script">Install the cluster init script</h3>

<p>On your application servers (<code class="language-plaintext highlighter-rouge">apps1</code> and <code class="language-plaintext highlighter-rouge">apps2</code>) you will need to
install the supplied init script:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cp -a /aspace/aspace-cluster.init /etc/init.d/aspace-cluster
 chkconfig --add aspace-cluster
</code></pre></div></div>

<p>This will start all configured instances when the system boots up, and
can also be used to start/stop individual instances.</p>

<h3 id="install-and-configure-nginx">Install and configure Nginx</h3>

<p>You will need to install Nginx on your <code class="language-plaintext highlighter-rouge">loadbalancer</code> machine, which
you can do by following the directions at
http://nginx.org/en/download.html.  Using the pre-built packages for
your platform is fine.  At the time of writing, the process for CentOS
is simply:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> wget http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm
 rpm -i nginx-release-centos-6-0.el6.ngx.noarch.rpm
 yum install nginx
</code></pre></div></div>

<p>Nginx will place its configuration files under <code class="language-plaintext highlighter-rouge">/etc/nginx/</code>.  For
now, the only change we need to make is to configure Nginx to load our
tenants’ configuration files.  To do this, edit
<code class="language-plaintext highlighter-rouge">/etc/nginx/conf.d/default.conf</code> and add the line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> include /aspace/nginx/conf/tenants/\*.conf;
</code></pre></div></div>

<p><em>Note:</em> the location of Nginx’s main config file might vary between
systems.  Another likely candidate is <code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code>.</p>

<h3 id="download-the-archivesspace-distribution">Download the ArchivesSpace distribution</h3>

<p>Rather than having every tenant maintain their own copy of the
ArchivesSpace software, we put a shared copy under
<code class="language-plaintext highlighter-rouge">/aspace/archivesspace/software/</code> and have each tenant instance refer
to that copy.  To set this up, run the following commands on any one
of the servers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/software/
 unzip -x /path/to/downloaded/archivesspace-x.y.z.zip
 mv archivesspace archivesspace-x.y.z
 ln -s archivesspace-x.y.z stable
</code></pre></div></div>

<p>Note that we unpack the distribution into a directory containing its
version number, and then assign that version the symbolic name
“stable”.  This gives us a convenient way of referring to particular
versions of the software, and we’ll use this later on when setting up
our tenant.</p>

<p>We’ll be using MySQL, which means we must make the MySQL connector
library available.  To do this, place it in the <code class="language-plaintext highlighter-rouge">lib/</code> directory of
the ArchivesSpace package:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/software/stable/lib
 wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.24/mysql-connector-java-5.1.24.jar
</code></pre></div></div>

<h2 id="defining-a-new-tenant">Defining a new tenant</h2>

<p>With our server setup out of the way, we’re ready to define our first
tenant.  As shown in <em>Overview of files</em> above, each tenant has their
own directory under <code class="language-plaintext highlighter-rouge">/aspace/archivesspace/tenants/</code> that holds all of
their configuration files.  In defining our new tenant, we will:</p>

<ul>
  <li>Create a Unix account for the tenant</li>
  <li>Create a database for the tenant</li>
  <li>Create a new set of ArchivesSpace configuration files for the
tenant</li>
  <li>Set up the database</li>
</ul>

<p>Our newly defined tenant won’t initially have any ArchivesSpace
instances, but we’ll set those up afterwards.</p>

<p>To complete the remainder of this process, there are a few bits of
information you will need.  In particular, you will need to know:</p>

<ul>
  <li>The identifier you will use for the tenant you will be creating.
In this example we use <code class="language-plaintext highlighter-rouge">exampletenant</code>.</li>
  <li>Which port numbers you will use for the application’s backend,
Solr instance, staff and public interfaces.  These must be free on
your application servers.</li>
  <li>If running each tenant under a separate Unix account, the UID and
GID you’ll use for them (which must be free on each of your
servers).</li>
  <li>The public-facing URLs for the new tenant.  We’ll use
<code class="language-plaintext highlighter-rouge">staff.example.com</code> for the staff interface, and <code class="language-plaintext highlighter-rouge">public.example.com</code>
for the public interface.</li>
</ul>

<h3 id="creating-a-unix-account">Creating a Unix account</h3>

<p>Although not strictly required, for security and ease of system
monitoring it’s a good idea to have each tenant instance running under
a dedicated Unix account.</p>

<p>We will call our new tenant <code class="language-plaintext highlighter-rouge">exampletenant</code>, so let’s create a user
and group for them now.  You will need to run these commands on <em>both</em>
application servers (<code class="language-plaintext highlighter-rouge">apps1</code> and <code class="language-plaintext highlighter-rouge">apps2</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> groupadd --gid 2000 exampletenant
 useradd --uid 2000 --gid 2000 exampletenant
</code></pre></div></div>

<p>Note that we specify a UID and GID explicitly to ensure they match
across machines.</p>

<h3 id="creating-the-database">Creating the database</h3>

<p>ArchivesSpace assumes that each tenant will have their own MySQL
database.  You can create this from the MySQL shell:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> create database exampletenant default character set utf8;
 grant all on exampletenant.* to 'example'@'%' identified by 'example123';
</code></pre></div></div>

<p>In this example, we have a MySQL database called <code class="language-plaintext highlighter-rouge">exampletenant</code>, and
we grant full access to the user <code class="language-plaintext highlighter-rouge">example</code> with password <code class="language-plaintext highlighter-rouge">example123</code>.
Assuming our database server is <code class="language-plaintext highlighter-rouge">db.example.com</code>, this corresponds to
the database URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> jdbc:mysql://db.example.com:3306/exampletenant?user=example&amp;password=example123&amp;useUnicode=true&amp;characterEncoding=UTF-8
</code></pre></div></div>

<p>We’ll make use of this URL in the following section.</p>

<h3 id="creating-the-tenant-configuration">Creating the tenant configuration</h3>

<p>Each tenant has their own set of files under the
<code class="language-plaintext highlighter-rouge">/aspace/archivesspace/tenants/</code> directory.  We’ll define our new
tenant (called <code class="language-plaintext highlighter-rouge">exampletenant</code>) by copying the template set of
configurations and running the <code class="language-plaintext highlighter-rouge">init_tenant.sh</code> script to set them
up.  We can do this on either <code class="language-plaintext highlighter-rouge">apps1</code> or <code class="language-plaintext highlighter-rouge">apps2</code>–it only needs to be
done once:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants
 cp -a \_template exampletenant
</code></pre></div></div>

<p>Note that we’ve named the tenant <code class="language-plaintext highlighter-rouge">exampletenant</code> to match the Unix
account it will run as.  Later on, the startup script will use this
fact to run each instance as the correct user.</p>

<p>For now, we’ll just edit the configuration file for this tenant, under
<code class="language-plaintext highlighter-rouge">exampletenant/archivesspace/config/config.rb</code>.  When you open this file you’ll see two
placeholders that need filling in: one for your database URL, which in
our case is just:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> jdbc:mysql://db.example.com:3306/exampletenant?user=example&amp;password=example123&amp;useUnicode=true&amp;characterEncoding=UTF-8
</code></pre></div></div>

<p>and the other for this tenant’s search, staff and public user secrets,
which should be random, hard to guess passwords.</p>

<h2 id="adding-the-tenant-instances">Adding the tenant instances</h2>

<p>To add our tenant instances, we just need to initialize them on each
of our servers.  On <code class="language-plaintext highlighter-rouge">apps1</code> <em>and</em> <code class="language-plaintext highlighter-rouge">apps2</code>, we run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants/exampletenant/archivesspace
 ./init_tenant.sh stable
</code></pre></div></div>

<p>If you list the directory now, you will see that the <code class="language-plaintext highlighter-rouge">init_tenant.sh</code>
script has created a number of symlinks.  Most of these refer back to
the <code class="language-plaintext highlighter-rouge">stable</code> version of the ArchivesSpace software we unpacked
previously, and some contain references to the <code class="language-plaintext highlighter-rouge">data</code> and <code class="language-plaintext highlighter-rouge">logs</code>
directories stored under <code class="language-plaintext highlighter-rouge">/aspace.local</code>.</p>

<p>Each server has its own configuration file that tells the
ArchivesSpace application which ports to listen on.  To set this up,
make two copies of the example configuration by running the following
command on <code class="language-plaintext highlighter-rouge">apps1</code> then <code class="language-plaintext highlighter-rouge">apps2</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants/exampletenant/archivesspace
 cp config/instance_hostname.rb.example config/instance_`hostname`.rb
</code></pre></div></div>

<p>Then edit each file to set the URLs that the instance will use.
Here’s our <code class="language-plaintext highlighter-rouge">config/instance_apps1.example.com.rb</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {
   :backend_url =&gt; "http://apps1.example.com:8089",
   :frontend_url =&gt; "http://apps1.example.com:8080",
   :solr_url =&gt; "http://apps1.example.com:8090",
   :indexer_url =&gt; "http://apps1.example.com:8091",
   :public_url =&gt; "http://apps1.example.com:8081",
 }
</code></pre></div></div>

<p>Note that the filename is important here: it must be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> instance_[server hostname].rb
</code></pre></div></div>

<p>These URLs will determine which ports the application listens on when
it starts up, and are also used by the ArchivesSpace indexing system
to track updates across the cluster.</p>

<h3 id="starting-up">Starting up</h3>

<p>As a one-off, we need to populate this tenant’s database with the
default set of tables.  You can do this by running the
<code class="language-plaintext highlighter-rouge">setup-database.sh</code> script on either <code class="language-plaintext highlighter-rouge">apps1</code> or <code class="language-plaintext highlighter-rouge">apps2</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/archivesspace/tenants/exampletenant/archivesspace
 scripts/setup-database.sh
</code></pre></div></div>

<p>With the two instances configured, you can now use the init script to
start them up on each server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /etc/init.d/aspace-cluster start-tenant exampletenant
</code></pre></div></div>

<p>and you can monitor each instance’s log file under
<code class="language-plaintext highlighter-rouge">/aspace.local/tenants/exampletenant/logs/</code>.  Once they’re started,
you should be able to connect to each instance with your web browser
at the configured URLs.</p>

<h2 id="configuring-the-load-balancer">Configuring the load balancer</h2>

<p>Our final step is configuring Nginx to accept requests for our staff
and public interfaces and forward them to the appropriate application
instance.  Working on the <code class="language-plaintext highlighter-rouge">loadbalancer</code> machine, we create a new
configuration file for our tenant:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd /aspace/nginx/conf/tenants
 cp -a \_template.conf.example exampletenant.conf
</code></pre></div></div>

<p>Now open <code class="language-plaintext highlighter-rouge">/aspace/nginx/conf/tenants/exampletenant.conf</code> in an
editor.  You will need to:</p>

<ul>
  <li>Replace <code class="language-plaintext highlighter-rouge">&lt;tenantname&gt;</code> with <code class="language-plaintext highlighter-rouge">exampletenant</code> where it appears.</li>
  <li>Change the <code class="language-plaintext highlighter-rouge">server</code> URLs to match the hostnames and ports you
configured each instance with.</li>
  <li>Insert the tenant’s hostnames for each <code class="language-plaintext highlighter-rouge">server_name</code> entry.  In
our case these are <code class="language-plaintext highlighter-rouge">public.example.com</code> for the public interface, and
<code class="language-plaintext highlighter-rouge">staff.example.com</code> for the staff interface.</li>
</ul>

<p>Once you’ve saved your configuration, you can test it with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /usr/sbin/nginx -t
</code></pre></div></div>

<p>If Nginx reports that all is well, reload the configurations with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /usr/sbin/nginx -s reload
</code></pre></div></div>

<p>And, finally, browse to <code class="language-plaintext highlighter-rouge">http://public.example.com/</code> to verify that Nginx
is now accepting requests and forwarding them to your app servers.
We’re done!</p>


      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/archivesspace">ArchivesSpace</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/tech-docs/assets/js/scale.fix.js"></script>
  </body>
</html>
